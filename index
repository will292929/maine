<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Maine Absentee Drop Box & Office Hours</title>
  <meta name="theme-color" content="#0b1220" />

  <style>
    :root{
      --bg:#0b1220;
      --card:#121a2b;
      --muted:#9aa7bd;
      --text:#eaf0ff;
      --stroke:rgba(255,255,255,.10);
      --accent:#6ea8ff;
      --danger:#ff6e6e;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(110,168,255,.18), transparent 60%),
        radial-gradient(900px 500px at 90% 10%, rgba(255,110,110,.10), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter:blur(10px);
      background:rgba(11,18,32,.85);
      border-bottom:1px solid var(--stroke);
    }
    .wrap{max-width:980px; margin:0 auto; padding:14px 14px 24px;}
    .title{display:flex; gap:10px; align-items:baseline; flex-wrap:wrap; margin:6px 0 10px;}
    .title h1{font-size:18px; margin:0; letter-spacing:.2px;}
    .title .sub{color:var(--muted); font-size:12px;}

    .controls{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      padding-bottom:10px;
    }
    @media (min-width: 720px){
      .controls{grid-template-columns: 1fr 160px; align-items:end;}
    }

    label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px;}

    input, button{
      width:100%;
      min-width:0;
      border-radius:14px;
      padding:12px 12px;
      border:1px solid var(--stroke);
      background:rgba(18,26,43,.80);
      color:var(--text);
      outline:none;
      font-size:14px;
      line-height:1.2;
    }
    input::placeholder{color:rgba(154,167,189,.7);}

    button{
      cursor:pointer;
      background:linear-gradient(180deg, rgba(110,168,255,.28), rgba(110,168,255,.12));
      border:1px solid rgba(110,168,255,.35);
      font-weight:600;
    }
    button:active{transform:translateY(1px);}

    .meta-row{display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; color:var(--muted); font-size:12px;}
    .pill{
      display:inline-flex; gap:6px; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--stroke);
    }

    .chips{
      margin-top:10px;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }
    .chip{
      border:1px solid var(--stroke);
      background:rgba(255,255,255,.05);
      color:var(--text);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{
      border-color: rgba(110,168,255,.55);
      background: rgba(110,168,255,.16);
    }

    main{padding:16px 0 40px;}
    .list{display:grid; gap:10px;}
    .card{
      border-radius:18px;
      background:rgba(18,26,43,.72);
      border:1px solid var(--stroke);
      padding:12px;
    }
    .card-top{display:flex; justify-content:space-between; gap:12px; align-items:flex-start;}
    .muni{font-weight:800; font-size:15px; margin:0;}
    .wp{
      color:var(--muted); font-size:12px; white-space:nowrap;
      border:1px solid var(--stroke);
      padding:6px 10px; border-radius:999px;
      background:rgba(255,255,255,.04);
    }
    .row{margin-top:8px;}
    .k{color:var(--muted); font-size:12px; margin-bottom:4px;}
    .v{font-size:13px; line-height:1.35; white-space:pre-wrap;}
    .na{color:rgba(154,167,189,.75);}
    .footer-note{
      margin-top:18px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
    .warn{color:rgba(255,110,110,.92);}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="title">
      <h1>Maine Municipal Office Hours & Absentee Drop Box Locations</h1>
      <div class="sub">Search statewide (optional county filter)</div>
    </div>

    <div class="controls">
      <div>
        <label for="q">Search (municipality, county, hours, address)</label>
        <input id="q" type="search" placeholder="e.g., Bangor, Penobscot, 8am, Main Street…" />
      </div>
      <div>
        <label>&nbsp;</label>
        <button id="shareBtn" type="button">Copy Share Link</button>
      </div>
    </div>

    <div class="meta-row">
      <div class="pill"><span id="statusText">Loading data…</span></div>
      <div class="pill"><span id="countPill">0 results</span></div>
      <div class="pill"><span id="countyPill">County: All</span></div>
    </div>

    <div id="chips" class="chips" aria-label="County filters"></div>
  </div>
</header>

<main class="wrap">
  <div id="list" class="list"></div>

  <div class="footer-note">
    <span class="warn">Reality check:</span> hours and locations can change; this site is only as current as the posted dataset.
  </div>
</main>

<script>
  const qInput = document.getElementById('q');
  const listEl = document.getElementById('list');
  const countPill = document.getElementById('countPill');
  const shareBtn = document.getElementById('shareBtn');
  const statusText = document.getElementById('statusText');
  const chipsEl = document.getElementById('chips');
  const countyPill = document.getElementById('countyPill');

  let DATA = [];
  let activeCountyCode = ""; // empty = All

  function esc(s){
    return (s ?? '').toString()
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");
  }
  function normalize(s){ return (s ?? '').toString().trim().toLowerCase(); }

  function getParams(){
    const u = new URL(window.location.href);
    return { county: u.searchParams.get('county') || '', q: u.searchParams.get('q') || '' };
  }
  function setParams(countyCode, q){
    const u = new URL(window.location.href);
    if(countyCode) u.searchParams.set('county', countyCode); else u.searchParams.delete('county');
    if(q) u.searchParams.set('q', q); else u.searchParams.delete('q');
    history.replaceState({}, "", u.toString());
  }

  function validateDataShape(rows){
    if(!Array.isArray(rows)) throw new Error("data.json must be a JSON array.");
    if(rows.length === 0) throw new Error("data.json is empty ([]). No data = no search.");
    const sample = rows[0];
    const required = ["countyCode","countyName","municipality","wp","officeHours","dropBoxLocation"];
    const missing = required.filter(k => !(k in sample));
    if(missing.length){
      throw new Error("data.json keys don't match expected fields. Missing: " + missing.join(", "));
    }
  }

  function buildCountyChips(data){
    const counties = Array.from(new Map(data.map(r => [r.countyCode, r.countyName])).entries())
      .map(([countyCode, countyName]) => ({ countyCode, countyName }))
      .sort((a,b) => a.countyName.localeCompare(b.countyName));

    chipsEl.innerHTML = counties.map(c => `
      <div class="chip" data-code="${esc(c.countyCode)}" title="Filter to ${esc(c.countyName)}">
        ${esc(c.countyName)}
      </div>
    `).join("");

    chipsEl.addEventListener('click', (e) => {
      const chip = e.target.closest('.chip');
      if(!chip) return;
      const code = chip.getAttribute('data-code') || "";

      // toggle
      activeCountyCode = (activeCountyCode === code) ? "" : code;

      // update UI active states
      for(const el of chipsEl.querySelectorAll('.chip')){
        el.classList.toggle('active', el.getAttribute('data-code') === activeCountyCode && activeCountyCode !== "");
      }

      updateCountyPill();
      render();
    });

    return counties;
  }

  function updateCountyPill(){
    if(!activeCountyCode){
      countyPill.textContent = "County: All";
      return;
    }
    const row = DATA.find(r => r.countyCode === activeCountyCode);
    countyPill.textContent = row ? `County: ${row.countyName}` : `County: ${activeCountyCode}`;
  }

  function render(){
    const q = normalize(qInput.value);

    let rows = DATA;

    if(activeCountyCode){
      rows = rows.filter(r => r.countyCode === activeCountyCode);
    }

    if(q){
      rows = rows.filter(r => {
        const blob = normalize([
          r.countyName, r.countyCode, r.municipality, r.officeHours, r.dropBoxLocation, r.wp
        ].join(" "));
        return blob.includes(q);
      });
    }

    countPill.textContent = `${rows.length} result${rows.length === 1 ? "" : "s"}`;

    if(rows.length === 0){
      listEl.innerHTML = `
        <div class="card">
          <div class="muni">No matches</div>
          <div class="row"><div class="v na">Try a different search (or clear the county filter).</div></div>
        </div>`;
      setParams(activeCountyCode, qInput.value.trim());
      return;
    }

    // Render a reasonable number fast; you can lift this cap if you want.
    const MAX = 400;
    const shown = rows.slice(0, MAX);

    listEl.innerHTML = shown.map(r => {
      const hours = (r.officeHours || "").trim() || "N/A";
      const box = (r.dropBoxLocation || "").trim() || "N/A";
      return `
        <div class="card">
          <div class="card-top">
            <div>
              <div class="muni">${esc(r.municipality)}</div>
              <div class="k">${esc(r.countyName)} (${esc(r.countyCode)})</div>
            </div>
            <div class="wp">${esc(r.wp || "")}</div>
          </div>

          <div class="row">
            <div class="k">Office hours (30 days prior)</div>
            <div class="v ${hours === "N/A" ? "na" : ""}">${esc(hours)}</div>
          </div>

          <div class="row">
            <div class="k">Absentee drop box location</div>
            <div class="v ${box === "N/A" ? "na" : ""}">${esc(box)}</div>
          </div>
        </div>
      `;
    }).join("");

    if(rows.length > MAX){
      const extra = rows.length - MAX;
      listEl.insertAdjacentHTML("beforeend", `
        <div class="card">
          <div class="muni">Showing first ${MAX} results</div>
          <div class="row"><div class="v na">${extra} more match your filters. Refine search to narrow it down.</div></div>
        </div>
      `);
    }

    setParams(activeCountyCode, qInput.value.trim());
  }

  async function init(){
    try{
      statusText.textContent = "Loading data.json…";
      const res = await fetch('./data.json', { cache:'no-store' });
      if(!res.ok) throw new Error(`Failed to load data.json (HTTP ${res.status}).`);

      const rows = await res.json();
      validateDataShape(rows);

      DATA = rows;
      statusText.textContent = `Loaded ${DATA.length} rows`;

      buildCountyChips(DATA);

      const params = getParams();
      if(params.q) qInput.value = params.q;

      if(params.county && DATA.some(r => r.countyCode === params.county)){
        activeCountyCode = params.county;
        // mark active chip
        for(const el of chipsEl.querySelectorAll('.chip')){
          el.classList.toggle('active', el.getAttribute('data-code') === activeCountyCode);
        }
      }

      updateCountyPill();
      render();
    } catch(err){
      statusText.textContent = `ERROR: ${err.message}`;
      console.error(err);
      DATA = [];
      render();
    }
  }

  qInput.addEventListener('input', () => window.requestAnimationFrame(render));

  shareBtn.addEventListener('click', async () => {
    const url = window.location.href;
    try{
      await navigator.clipboard.writeText(url);
      shareBtn.textContent = "Copied!";
      setTimeout(() => (shareBtn.textContent = "Copy Share Link"), 900);
    } catch(e){
      prompt("Copy this link:", url);
    }
  });

  init();
</script>
</body>
</html>

